              SCHOOL OF COMPUTING AND ENGINEERING SCIENCES
       BACHELOR OF SCIENCE IN ELECTRICAL AND ELECTRONICS ENGINEERING
                            2nd SEMESTER 2025/2026
                       BEE 5214: Multivariate Control Lab_4

DATE: February, 2026

1. Title:
Simulation and practical implementation of CKF + PI Control of a Quadcopter (X
Configuration)
2. Objective:
2.1 Implement the quadcopter digitized EOM and allocator for quadcopter X
    configuration.
2.2 Use fixed step forward Euler to simulate CKF + PI controller for (i) altitude-only
    hover and (ii) cascaded altitude + attitude for the quadcopter.
2.3 Implement fixed step forward Euler CKF + PI controller for (i) altitude-only hover
    and (ii) cascaded altitude + attitude for the quadcopter.
3. Learning Outcomes:
By completing this laboratory, students will be able to:
3.1 Build body/world dynamics and the mixer ğ´! from geometry.
3.2 Assemble an X quadcopter
3.3 Simulate attitude CKF + PI loops with anti-windup and saturation
3.4 Simulate attitude and altitude CKF + PI loops with anti-windup and saturation
3.5 Understand bandwidth separation between inner attitude and outer altitude loops for
    the quadcopter.
3.6 Implement attitude CKF + PI loops with anti-windup and saturation
4.0 Homework

  Print the quadcopter motor mounting chassis and arms and assemble the quadcopter as
  shown in Fig. 4.2.



                                         Page 1 of 8
      Quadcopter (X)




              Fig. 4.1 Quadcopter geometry




                              Fig. 4.2 X Quadcopter assembly
                                                                                              60 Marks
4.1   X Quadcopter EOM

      Flying Car (Drone) X Configuration
      Body Frame - Refer to Fig. 4.1
      â€¢ ğ‘¥          â†’ East         ğ‘¦ â†’ North                   ğ‘§ â†’ Up
      â€¢ Roll about ğ‘¥              Pitch about ğ‘¦               Yaw about ğ‘§

      Rigid body states
      Position (3) [ğ‘¥, ğ‘¦, ğ‘§]          Velocity (3)            (ğ‘£! , ğ‘£" , ğ‘£# *

      Motor
      Motor Input Voltages (4) [ğ‘‰$ , ğ‘‰% , ğ‘‰& , ğ‘‰' ] Motor Currents (4) [ğ‘–$ , ğ‘–% , ğ‘–& , ğ‘–' ]
      Motor Speeds (4) [ğœ”$ , ğœ”% , ğœ”& , ğœ”' ]

                                                Page 2 of 8
  Flying Car (Drone) Model Parameters and Difference Equations
  Drone mass M
  Motor constants Jm bm, kt, kb, L, R, Ï„
  Drone angular momentum in x, y, z reference frame Ix (roll) Iy (pitch) Iz (Yaw)
  Drone velocity damping coefficeints in x, y, z reference frame kdx , kdy , kdz
  Drone propeller viscous damping coefficients kÎ¸, kÏ†, kÏˆ
  The drone assembly shown in Fig. 4.2 may have upto 24 state variables;
    (i)  Drone position and velocity in x, y, z coordinates - 6 state variables,
   (ii)  Drone angular position and speed in x, y and z axis â€“ 6 state variables
  (iii)  Drone motor input voltage, current, propeller speed
         - 3 state variables for each motor making a total of 12 state variables for 4 motors.


Motor M1 /Propeller Parameters                               Motor M1 /Propeller Parameters
ğ‘…( Winding resstance           0.1Î©                          CTi Propeller thrust constant
ğ¿( Winding inductance          0.002Î—                        CQi Propeller drag constant
ğ‘˜-( Back EMF Constant          0.01 Vs/rad                   Ri Propeller radius
ğ‘˜,( Torque Constant            0.01 N/A                      Ai = Ï€ğ‘…(% = Propeller disc area
ğ‘.( Motor damping coefficient. 0.00009Ns/rad                 Ï Air density
ğ½.( Motor/Propeller inertia    0.0004 kgm2                   l Drone arm                   0.1m
ğ‘˜/( Propeller aerodynamic drag 0.000002 Ns2/rad2             Varibles
      coefficient = CQ1ÏA1ğ‘…$&                                ğ‘–$ Motor current.              20A (Max)
ğ‘˜ 0( Propeller trust           0.000018 Ns2/rad2             ğœ”( Propeller speed
     coefficient = CTiÏAiğ‘…(%                                 ğ‘‰( Input voltage              12V (Max)
kdx = kdy Velocity damping     0.15 Ns/m                     m Drone mass                  1.5 kg
kdz Velocity damping           0.25 Ns/m                     Ix = Iy                       0.02 kgm2
kÎ¸ = kÏ† Viscous damping        0.002 Ns/rad                  Iz Angular momentum           0.04 kgm2
kÏˆ Viscous damping             0.003                         Ts Sampling time              0.004s
                                                             g Gravity acceleration        9.81 ms-2


  Motor Electrical Dynamics
     )*Ì‡
  ğ¿( ),! = âˆ’ğ‘…( ğ‘–( âˆ’ ğ‘˜-( ğœ”( + ğ‘‰(
  Motor Mechanical Dynamics
  ğ½.( ğœ”Ì‡ ( = ğ‘˜,( ğ‘–( âˆ’ ğ‘.( ğœ”( âˆ’ ğ‘˜/( ğœ”(%

  Thrust and Torques
                 '

          ğ‘‡ = 9 ğ‘˜ 0( ğœ”(%
               (1$

  X-configuration torques:
                ğ‘™
         ğœ2 =     (ğ‘˜ 0% ğœ”%% + ğ‘˜ 0& ğœ”&% âˆ’ ğ‘˜ 0$ ğœ”$% âˆ’ ğ‘˜ 0' ğœ”'% )
               âˆš2
                ğ‘™
         ğœ3 =     (ğ‘˜ 0$ ğœ”$% + ğ‘˜ 0% ğœ”%% âˆ’ ğ‘˜ 0& ğœ”&% âˆ’ ğ‘˜ 0% ğœ”'% )
              âˆš2
         ğœ4 = ğ‘˜/$ ğœ”$% âˆ’ ğ‘˜/% ğœ”%% + ğ‘˜/& ğœ”&% âˆ’ ğ‘˜/' ğœ”'%

  Translational Dynamics   ğ‘¥Ì‡ = ğ‘£!       ğ‘¦Ì‡ = ğ‘£"                          ğ‘§Ì‡ = ğ‘£#
        ğ‘šğ‘£Ì‡! = ğ‘‡(cosğœ™sinğœƒcosğœ“ + sinğœ™sinğœ“) âˆ’ ğ‘˜)! ğ‘£!
        ğ‘šğ‘£Ì‡" = ğ‘‡(cosğœ™sinğœƒsinğœ“ âˆ’ sinğœ™cosğœ“) âˆ’ ğ‘˜)" ğ‘£"
        ğ‘šğ‘£Ì‡# = ğ‘‡(cosğœ™cosğœƒ) âˆ’ ğ‘šğ‘” âˆ’ ğ‘˜)# ğ‘£#

                                             Page 3 of 8
      Rotational Dynamics (gyroscopic)
                   ğ¼! ğ‘Ì‡ = ğœ2 + Lğ¼" âˆ’ ğ¼# Mğ‘ğ‘Ÿ - kÏ†p
                   ğ¼" ğ‘Ì‡ = ğœ3 + (ğ¼# âˆ’ ğ¼! )ğ‘ğ‘Ÿ - kÎ¸q
                   ğ¼# ğ‘ŸÌ‡ = ğœ4 + Lğ¼! âˆ’ ğ¼" Mğ‘ğ‘ â€“ kÏˆ r

      Euler Kinematics
                  ğœ™Ì‡ = ğ‘ + ğ‘sinğœ™tanğœƒ + ğ‘Ÿcosğœ™tanğœƒ

                      ğœƒÌ‡ = ğ‘cosğœ™ âˆ’ ğ‘Ÿsinğœ™

                           67892:;<=72
                      ğœ“Ì‡ =     <=73


      Hover equilibrium:       ğœ™ = ğœƒ = 0 ğ‘ = ğ‘ = ğ‘Ÿ = 0 ğ‘£! = ğ‘£" = ğ‘£# = 0. ğœ”( = ğœ”> (hover speed)
                                                                               $    .?
      Hover condition:                     4ğ‘˜ 0 ğœ”>% = ğ‘šğ‘”                ğœ”> = % U @
                                                                                      "

      State vector:
                                                                                                           0
                      ğ‘‹ = (ğ‘–$ , ğ‘–% , ğ‘–& , ğ‘–' , ğœ”$ , ğœ”% , ğœ”& , ğœ”' , ğ‘¥, ğ‘¦, ğ‘§, ğ‘£! , ğ‘£" , ğ‘£# , ğœ™, ğœƒ, ğœ“, ğ‘, ğ‘, ğ‘Ÿ*

      Control inputs (Motor voltages):
                   ğ‘ˆ = [ğ‘‰$ , ğ‘‰% , ğ‘‰% , ğ‘‰% ]0

4.2   Forward Euler Discretization
      Motor Dynamics
      Electrical:
                                 ğ‘‡B
                  ğ‘–(,@:$ = ğ‘–(,@ + Lâˆ’ğ‘…( ğ‘–(,@ âˆ’ ğ‘˜-( ğœ”(,@ + ğ‘‰(,@ M
                                 ğ¿(

      Mechanical:
                                             ğ‘‡B                             %
                      ğœ”(,@:$ = ğœ”(,@ +           Lğ‘˜,( ğ‘–(,@ âˆ’ ğ‘.( ğœ”(,@ âˆ’ ğ‘˜/( ğœ”(,@ M
                                            ğ½.(

      Translational Dynamics
                                      ğ‘‡B
                      ğ‘£!,@:$ = ğ‘£!,@ +    (ğ‘‡ (cosğœ™@ sinğœƒ@ cosğœ“@ + sinğœ™@ sinğœ“@ ) âˆ’ ğ‘˜)! ğ‘£!,@ *
                                      ğ‘š @
                                      0
                      ğ‘£",@:$ = ğ‘£",@ + .# (ğ‘‡@ (cosğœ™@ sinğœƒ@ sinğœ“@ âˆ’ sinğœ™@ cosğœ“@ ) âˆ’ ğ‘˜)" ğ‘£",@ *
                                     ğ‘‡B
                      ğ‘£#,@:$ = ğ‘£#,@ + (ğ‘‡@ (cosğœ™@ cosğœƒ@ ) âˆ’ ğ‘šğ‘” âˆ’ ğ‘˜)# ğ‘£#,@ *
                                     ğ‘š

      Position update:
                   ğ‘¥@:$ = ğ‘¥@ + ğ‘‡B ğ‘£!,@ , ğ‘¦@:$ = ğ‘¦@ + ğ‘‡B ğ‘£",@ , ğ‘§@:$ = ğ‘§@ + ğ‘‡B ğ‘£#,@

      Body Rotational Dynamics
                               0
                   ğ‘@:$ = ğ‘@ + C # (ğœ2,@ + Lğ¼" âˆ’ ğ¼# Mğ‘@ ğ‘Ÿ@ * - kÏ† ğ‘@
                                        $
                                       0
                      ğ‘@:$ = ğ‘@ + C # (ğœD,@ + (ğ¼# âˆ’ ğ¼! )ğ‘@ ğ‘Ÿ@ * - kÎ¸ ğ‘@
                                        %
                                      0#
                      ğ‘Ÿ@:$ = ğ‘Ÿ@ + C (ğœE,@ + Lğ¼! âˆ’ ğ¼" Mğ‘@ ğ‘@ * - kÏˆ ğ‘Ÿ@
                                       &




                                                      Page 4 of 8
      Euler Angle Kinematics
                   ğœ™@:$ = ğœ™@ + ğ‘‡B [ğ‘@ + ğ‘@ sinğœ™@ tanğœƒ@ + ğ‘Ÿ@ cosğœ™@ tanğœƒ@ ]

                     ğœƒ@:$ = ğœƒ@ + ğ‘‡B [ğ‘@ cosğœ™@ âˆ’ ğ‘Ÿsinğœ™@ ]

                                       6 7892' :;<=72'
                     Ïˆ@:$ = Ïˆ@ + ğ‘‡B Y '    <=73'
                                                         Z



4.3   Write Python code to simulate and plot CKF-PI Altitude/Hover

      Initial Conditions:
      All states initialized to zero
      Motors initialized to hover speed:

                     1 ğ‘šğ‘”
             ğœ”" =     &
                     2 ğ‘˜#

             ğœ”" > 450 rad/s
      Total Thrust
                     %
                         *
             ğ‘‡$ = + ğ‘˜ # ğœ”&,$
                    &'(

      PI Attitude Control
             ğ‘¢+ = ğ¾,+ ğ‘’+ + ğ¾&+ âˆ« ğ‘’+ ğ‘‘ğ‘¡

             ğ‘¢- = ğ¾,- ğ‘’- + ğ¾&- âˆ« ğ‘’- ğ‘‘ğ‘¡

             ğ‘¢. = ğ¾,. ğ‘’. + ğ¾&. âˆ« ğ‘’. ğ‘‘ğ‘¡
      Where:
             ğ‘’+ = ğœ™/01 âˆ’ ğœ™5

             CKF-estimated states are used.
      Motor Voltage Mixing (X Configuration)
                                    ğ‘‰(                   ğ‘¢+
                                    ğ‘‰                    ğ‘¢-
                               ğ• = 7 * 9 = ğ‘‰"340/ + ğ‘€5( 7ğ‘¢ 9
                                    ğ‘‰2                    .
                                    ğ‘‰%                    0




                                             Page 5 of 8
        Cubature Kalman Filter (CKF)
        State Model
                         ğ‘¥$6( = ğ‘“ (ğ‘¥$ , ğ‘¢$ ) + ğ‘¤$
        Measurement Model
                         ğ‘¦$ = [ğ‘§    ğœ™     ğœƒ    ğœ“]# + ğ‘£$
        CKF Algorithm
        For ğ‘› states:
        (i)        Generate 2ğ‘› cubature points:
                   ğœ‰& = âˆšğ‘› ğ‘’&
        (iii)      Time update:
                o Propagate cubature points through nonlinear dynamics.
                o Compute predicted mean and covariance.
        (iv)       Measurement update:
         (v)       Propagate cubature points through measurement equation.
        (vi)       Compute Kalman gain.

      Required Plots

        (i)       Motor voltages ğ‘‰( â€“ğ‘‰%

        (ii)      Motor currents ğ‘–( â€“ğ‘–%

       (iii)      Propeller speeds ğœ”( â€“ğœ”%

       (iv)       Height ğ‘§(ğ‘¡)

        (v)       Roll, pitch, yaw response
                                                                             40 Marks

4.4     Write Python to simulate CKF + PI Attitude + Altitude Control with velocity
        (ğ’—ğ’™ )
        Altitude PI Controller
                   ğ‘¢8 = ğ¾,8 ğ‘’8 + ğ¾&8 âˆ« ğ‘’8 ğ‘‘ğ‘¡
                   ğ‘’8 = ğ‘§/01 âˆ’ ğ‘§Ì‚




                                                 Page 6 of 8
        Thrust Command
                  ğ‘‡9:; = ğ‘šğ‘” + ğ‘¢8
                  Desired hover speed:

                          ğ‘‡9:;
                  ğœ”9:; = &
                           4ğ‘˜ #

                  Forward Velocity Generation
                  ğœƒ/01 = ğ¾4 Qğ‘£<,/01 âˆ’ ğ‘£R< S
        Cascaded control structure:
                Altitude â†’ Thrust â†’ Velocity â†’ Pitch â†’ Torque â†’ Motor Voltages

      Required Plots
        (i)       Motor voltages
        (ii)      Motor currents
        (iii)     Propeller speeds
        (iv)      Height ğ‘§(ğ‘¡)
        (v)       Forward velocity ğ‘£< (ğ‘¡)
        (vi)      Pitch angle response

              Tune attitude and altitude PI controller gains to achieve
               Performance Metric          Requirement
               Height overshoot              < 10%
               Settling time               <3s
               Forward velocity tracking < 5% error
               Attitude steady state error    â‰ˆ0

                                                                              50 Marks
5       Practical

5.1     Implement the CKF-PI Altitude/Hover Controller

        Convert the and run the Python code written in 4.3 with actual propeller speed
        measurement on the drone assembled in 4.0 and shown in Fig. 4.2
        Take a video of your drone hovering.


                                              Page 7 of 8
                                                                                            40 Marks

6. Lab Report                                                                               20 Marks

6.1      Use these guidelines
         https://drive.google.com/drive/u/2/folders/11saKDjuLBwEa5uQg5ynakZ3JinBQyGKl
         to write and upload your individual lab report detailing your journey through items 1 to 6.

6.2.1 Questions

         (i)     Why is CKF preferred over EKF for this system

         (ii)    What happens if motor dynamics are ignored?

         (iii)   How does Euler discretization affect stability?

         (iv)    What happens if sampling time increases?

References

      1. S. Skogestad and I. Postlethwaite, Multivariable Feedback Control: Analysis and Design, 2nd
         ed., Wiley.
      2. K. J. Ã…strÃ¶m and R. M. Murray, Feedback Systems: An Introduction for Scientists and Engi-
         neers, Princet




                                                 Page 8 of 8
